#!/bin/bash

set -e

. ~/.bashrc

: ${FREESWITCH_LOG_LEVEL:=info}
: ${FREESWITCH_LOG_COLOR:=true}

: ${FREESWITCH_RTP_START_PORT:=16384}
: ${FREESWITCH_RTP_END_PORT:=32768}

: ${MOD_KAZOO_LISTEN_IP:=0.0.0.0}

: ${FREESWITCH_DISABLE_NAT_DETECTION:=true}


echo "Reading erlang cookie ..."
if [ -f '/etc/secrets/erlang/cookie' ]; then
    echo "Cookie secret mounted ..."
    ERLANG_COOKIE=$(cat /etc/secrets/erlang/cookie)
else
    echo "*** No Erlang Cookie Mounted! ***"
    ERLANG_COOKIE=insecure-cookie
fi
echo "$ERLANG_COOKIE" > ~/.erlang.cookie


echo "Rewriting kazoo.conf.xml ..."
sed -ir "/listen-ip/s/0\.0\.0\.0/$MOD_KAZOO_LISTEN_IP/" \
    /etc/freeswitch/autoload_configs/kazoo.conf.xml

perl -i -pe 's/<!--(.*)(\/etc\/freeswitch\/autoload_configs\/\.erlang\.cookie)(.*)-->/$1\/opt\/freeswitch\/\.erlang\.cookie$3/' \
    /etc/freeswitch/autoload_configs/kazoo.conf.xml

sed -ir '/change_me/s/\(<.*>\)/<!--\1/' \
    /etc/freeswitch/autoload_configs/kazoo.conf.xml

cat /etc/freeswitch/autoload_configs/kazoo.conf.xml


echo "Setting CONSOLE_LOG_LEVEL: $FREESWITCH_LOG_LEVEL ..."
sed -ir "/loglevel/s/info/$FREESWITCH_LOG_LEVEL/" /etc/freeswitch/autoload_configs/console.conf.xml
sed -ir "/colorize/s/true/$FREESWITCH_LOG_COLOR/" /etc/freeswitch/autoload_configs/console.conf.xml

cat /etc/freeswitch/autoload_configs/console.conf.xml


echo "Setting RTP Port Range Min/Max ..."
sed -ir "/rtp-start-port/s/16384/$FREESWITCH_RTP_START_PORT/" /etc/freeswitch/autoload_configs/switch.conf.xml
sed -ir "/rtp-end-port/s/32768/$FREESWITCH_RTP_END_PORT/" /etc/freeswitch/autoload_configs/switch.conf.xml

cat /etc/freeswitch/autoload_configs/switch.conf.xml


echo "Ensuring permissions ..."
chown -R freeswitch:freeswitch ~ /etc/freeswitch
chown freeswitch:freeswitch ~/.erlang.cookie
chmod 0600 ~/.erlang.cookie


echo "Building arguments ..."
[ "$FREESWITCH_DISABLE_NAT_DETECTION" == true ] && nonat_args='-nonat'


cd ~
    echo "Starting freeswitch ..."
    su freeswitch -c '/usr/bin/epmd -daemon'
    exec /usr/bin/freeswitch -c -u freeswitch -g freeswitch $nonat_args 2>&1
